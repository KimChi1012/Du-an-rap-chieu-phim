<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>High Cinema - Quản lí ưu đãi</title>
    <link rel="icon" type="image/png" sizes="1000x1000" href="images/logo-hc.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="css/style.css">
    <script src="https://unpkg.com/feather-icons"></script>
    <script type="module" src="js/script.js"></script>
    <script type="module" src="js/api/endow.js"></script>
    <script>
        console.log('Rich Text Editor loaded');
        
        // Rich Text Editor functionality
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Setting up rich text editor...');
            
            // Toolbar event handler - Complete implementation
            document.addEventListener('click', function(e) {
                const toolbarBtn = e.target.closest('.toolbar-btn');
                if (toolbarBtn) {
                    console.log('Toolbar button clicked:', toolbarBtn.dataset.command);
                    
                    e.preventDefault();
                    e.stopPropagation();
                    
                    const command = toolbarBtn.dataset.command;
                    const editor = document.querySelector('.editor-content');
                    
                    if (editor) {
                        // Ensure editor has focus
                        editor.focus();
                        
                        // Small delay to ensure focus is set
                        setTimeout(() => {
                            try {
                                let result = false;
                                
                                // Handle different command types
                                switch(command) {
                                    case 'bold':
                                    case 'italic':
                                    case 'underline':
                                        // Basic formatting commands
                                        result = document.execCommand(command, false, null);
                                        break;
                                        
                                    case 'insertUnorderedList':
                                    case 'insertOrderedList':
                                        // List commands
                                        result = document.execCommand(command, false, null);
                                        if (!result) {
                                            // Fallback for lists
                                            insertListManually(command === 'insertUnorderedList' ? 'ul' : 'ol');
                                            result = true;
                                        }
                                        break;
                                        
                                    case 'justifyLeft':
                                    case 'justifyCenter':
                                    case 'justifyRight':
                                    case 'justifyFull':
                                        // Alignment commands
                                        result = document.execCommand(command, false, null);
                                        if (!result) {
                                            // Fallback for alignment
                                            applyAlignment(command);
                                            result = true;
                                        }
                                        break;
                                        
                                    default:
                                        result = document.execCommand(command, false, null);
                                }
                                
                                console.log('Command executed:', command, 'Result:', result);
                                
                                // Update button states
                                setTimeout(updateButtonStates, 10);
                                
                                // Keep focus on editor
                                editor.focus();
                            } catch (error) {
                                console.error('Command error:', error);
                            }
                        }, 10);
                    }
                }
            });
            
            // Helper function to insert lists manually
            function insertListManually(type) {
                const editor = document.querySelector('.editor-content');
                const selection = window.getSelection();
                
                if (selection.rangeCount > 0) {
                    const range = selection.getRangeAt(0);
                    const list = document.createElement(type);
                    const listItem = document.createElement('li');
                    
                    // Get selected text or use default
                    const selectedText = range.toString() || 'Mục danh sách';
                    listItem.textContent = selectedText;
                    list.appendChild(listItem);
                    
                    try {
                        // Delete selected content if any
                        range.deleteContents();
                        range.insertNode(list);
                        
                        // Set cursor inside the list item
                        range.selectNodeContents(listItem);
                        selection.removeAllRanges();
                        selection.addRange(range);
                    } catch (error) {
                        console.error('List insertion error:', error);
                    }
                }
            }
            
            // Helper function to apply alignment manually
            function applyAlignment(alignCommand) {
                const editor = document.querySelector('.editor-content');
                const selection = window.getSelection();
                
                if (selection.rangeCount > 0) {
                    const range = selection.getRangeAt(0);
                    let container = range.commonAncestorContainer;
                    
                    // Find the appropriate container element
                    if (container.nodeType === Node.TEXT_NODE) {
                        container = container.parentElement;
                    }
                    
                    // Find the paragraph or div to apply alignment to
                    let targetElement = container.closest('p, div');
                    if (!targetElement || !editor.contains(targetElement)) {
                        targetElement = editor;
                    }
                    
                    // Apply alignment style
                    const alignmentMap = {
                        'justifyLeft': 'left',
                        'justifyCenter': 'center',
                        'justifyRight': 'right',
                        'justifyFull': 'justify'
                    };
                    
                    const alignment = alignmentMap[alignCommand];
                    if (alignment) {
                        targetElement.style.textAlign = alignment;
                    }
                }
            }
            
            // Keyboard shortcuts - Enhanced
            document.addEventListener('keydown', function(e) {
                // Check if we're in the editor
                const isInEditor = e.target.classList.contains('editor-content') || 
                                 e.target.closest('.editor-content');
                
                if ((e.ctrlKey || e.metaKey) && isInEditor) {
                    let command = null;
                    
                    switch(e.key.toLowerCase()) {
                        case 'b': 
                            command = 'bold'; 
                            break;
                        case 'i': 
                            command = 'italic'; 
                            break;
                        case 'u': 
                            command = 'underline'; 
                            break;
                        case 'l':
                            // Ctrl+L for bullet list
                            command = 'insertUnorderedList';
                            break;
                    }
                    
                    if (command) {
                        e.preventDefault();
                        
                        const editor = document.querySelector('.editor-content');
                        if (editor) {
                            editor.focus();
                            
                            try {
                                const result = document.execCommand(command, false, null);
                                console.log('Keyboard shortcut executed:', command, 'Result:', result);
                                
                                // Update button states
                                setTimeout(updateButtonStates, 10);
                            } catch (error) {
                                console.error('Keyboard shortcut error:', error);
                            }
                        }
                    }
                }
            });
            
            // Update button states - Enhanced
            function updateButtonStates() {
                const buttons = document.querySelectorAll('.toolbar-btn');
                buttons.forEach(button => {
                    const command = button.dataset.command;
                    let isActive = false;
                    
                    try {
                        // Check command state
                        if (command === 'bold' || command === 'italic' || command === 'underline') {
                            isActive = document.queryCommandState(command);
                        } else if (command === 'insertUnorderedList' || command === 'insertOrderedList') {
                            // Special handling for lists
                            const selection = window.getSelection();
                            if (selection.rangeCount > 0) {
                                const container = selection.getRangeAt(0).commonAncestorContainer;
                                const element = container.nodeType === Node.TEXT_NODE ? container.parentElement : container;
                                
                                if (command === 'insertUnorderedList') {
                                    isActive = !!element.closest('ul');
                                } else if (command === 'insertOrderedList') {
                                    isActive = !!element.closest('ol');
                                }
                            }
                        } else if (command.startsWith('justify')) {
                            // Special handling for alignment
                            const selection = window.getSelection();
                            if (selection.rangeCount > 0) {
                                const container = selection.getRangeAt(0).commonAncestorContainer;
                                const element = container.nodeType === Node.TEXT_NODE ? container.parentElement : container;
                                const targetElement = element.closest('p, div') || element;
                                
                                const alignmentMap = {
                                    'justifyLeft': 'left',
                                    'justifyCenter': 'center',
                                    'justifyRight': 'right',
                                    'justifyFull': 'justify'
                                };
                                
                                const expectedAlignment = alignmentMap[command];
                                const currentAlignment = targetElement.style.textAlign || 'left';
                                isActive = currentAlignment === expectedAlignment;
                            }
                        } else {
                            // Try standard queryCommandState
                            isActive = document.queryCommandState(command);
                        }
                        
                        button.classList.toggle('active', isActive);
                    } catch (error) {
                        // For unsupported commands, ignore
                        console.debug('Command state check failed for:', command);
                    }
                });
            }
            
            // Update states on selection change
            document.addEventListener('selectionchange', updateButtonStates);
            
            // Update states when editor content changes
            const observer = new MutationObserver(updateButtonStates);
            setTimeout(() => {
                const editor = document.querySelector('.editor-content');
                if (editor) {
                    observer.observe(editor, {
                        childList: true,
                        subtree: true,
                        attributes: true,
                        attributeFilter: ['style']
                    });
                }
            }, 1000);
            
            console.log('Rich text editor setup completed');
        });
        
        // Rich text editor object for compatibility
        window.richTextEditor = {
            getContent: function() {
                const editor = document.querySelector('.editor-content');
                return editor ? editor.innerHTML : '';
            },
            setContent: function(html) {
                const editor = document.querySelector('.editor-content');
                if (editor) editor.innerHTML = html;
            },
            getTextContent: function() {
                const editor = document.querySelector('.editor-content');
                return editor ? (editor.textContent || editor.innerText || '') : '';
            },
            clear: function() {
                const editor = document.querySelector('.editor-content');
                if (editor) editor.innerHTML = '';
            },
            focus: function() {
                const editor = document.querySelector('.editor-content');
                if (editor) editor.focus();
            }
        };
        
        // Debug functions
        window.testToolbar = function() {
            console.log('=== Testing Toolbar ===');
            const buttons = document.querySelectorAll('.toolbar-btn');
            console.log('Found buttons:', buttons.length);
            
            buttons.forEach((btn, index) => {
                console.log(`Button ${index}:`, {
                    command: btn.dataset.command,
                    title: btn.title,
                    clickable: true
                });
            });
            
            console.log('Try clicking buttons or use keyboard shortcuts:');
            console.log('- Ctrl+B for Bold');
            console.log('- Ctrl+I for Italic');
            console.log('- Ctrl+U for Underline');
            console.log('- Ctrl+L for Bullet List');
        };
        
        // Debug script để kiểm tra
        console.log('HTML loaded');
        // Kiểm tra sau 3 giây
        setTimeout(() => {
            console.log('=== DEBUG INFO ===');
            console.log('Table element:', document.getElementById('endowTable'));
            console.log('EndowManagement instance:', window.endowManagement);
            
            if (window.endowManagement) {
                console.log('EndowManagement data:', window.endowManagement.endows);
                console.log('Number of endows:', window.endowManagement.endows.length);
            }
            
            // Đảm bảo bảng hiển thị
            const table = document.querySelector('.endow-table');
            if (table) {
                table.style.display = 'table';
                table.style.width = '100%';
                table.style.borderCollapse = 'collapse';
                console.log('Table display ensured');
            }
            
            // Kiểm tra tbody
            const tbody = document.getElementById('endowTable');
            if (tbody) {
                console.log('Table body content:', tbody.innerHTML);
                console.log('Table body children count:', tbody.children.length);
            }
            
            // Test toolbar
            setTimeout(() => {
                if (window.testToolbar) {
                    window.testToolbar();
                }
            }, 1000);
        }, 3000);
    </script>
</head>

<body class="bg-white-50">
<div class="flex h-screen">
    
    <!-- Sidebar -->
    <div id="shared-sidebar" class="w-65"></div>

    <div class="flex-1 overflow-auto">
        <!-- Header -->
        <div id="shared-header"></div>

            <main class="p-8">
                <h1 class="text-3xl font-bold text-gray-800 mb-8 border-b pb-4">Quản lí ưu đãi</h1>

            <!-- ====== BẢNG ƯU ĐÃI ====== -->
            <div class="endow-table-container">
                <div class="flex items-center mb-6">
                    <h2 class="text-xl font-semibold text-gray-800">Danh sách ưu đãi</h2>
                    <div class="search-container">
                        <div class="search-border-gradient">
                            <input
                                id="searchInput"
                                type="text"
                                placeholder="Tìm theo Mã ưu đãi hoặc Tên ưu đãi..."
                                class="search-input"
                                oninput="window.endowManagement.searchEndows()"
                            >
                        </div>
                        <i class="fa fa-search search-icon"></i>
                    </div>
                    <!-- LỌC THEO NGÀY -->
                    <div class="flex items-center gap-2 ml-5">
                        <label class="text-sm text-gray-400">Từ</label>
                        <div class="search-border-gradient">
                            <input 
                                type="date" 
                                id="filterStartDate"
                                class="search-input text-sm"
                                onchange="window.endowManagement.filterByDate()"
                            >
                        </div>

                        <label class="text-sm text-gray-400">Đến</label>
                        <div class="search-border-gradient">
                            <input 
                                type="date" 
                                id="filterEndDate"
                                class="search-input text-sm"
                                onchange="window.endowManagement.filterByDate()"
                            >
                        </div>

                        <button 
                            onclick="window.endowManagement.resetFilter()"
                            class="add-endow-button"
                        >
                            Reset
                        </button>
                    </div>

                    <button onclick="window.endowManagement.openAdd()" class="add-endow-button">
                        <i class="fa fa-plus emoji"></i>Thêm ưu đãi
                    </button>
                </div>

                <div class="table-scroll-area">
                    <table class="endow-table" style="display: table; width: 100%; border-collapse: collapse;">
                        <thead class="table-header-gradient">
                            <tr>
                                <th class="table-header-cell w-[90px]">Mã Ưu Đãi</th>
                                <th class="table-header-cell w-[200px]">Tên Ưu Đãi</th>
                                <th class="table-header-cell w-[250px]">Mô Tả</th>
                                <th class="table-header-cell w-[140px]">Ngày Bắt Đầu</th>
                                <th class="table-header-cell w-[140px]">Ngày Kết Thúc</th>
                                <th class="table-header-cell w-[130px]">Ảnh</th>
                                <th class="table-header-cell w-[150px]">Hành Động</th>
                            </tr>
                        </thead>
                        <tbody id="endowTable" class="divide-y divide-gray-100 bg-white" style="display: table-row-group;"></tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>
</div>
<!-- MODAL -->
<div id="endowModal" class="endow-modal hidden" onclick="window.endowManagement.handleModalClick(event)">
    <div class="endow-modal-content" onclick="event.stopPropagation()">
        <div class="flex justify-between items-center mb-2">
            <h3 id="modalTitle" class="text-base font-semibold"></h3>
            <button onclick="window.endowManagement.closeModal()" class="text-gray-500 hover:text-gray-700 text-lg">&times;</button>
        </div>

        <div class="endow-form-grid">
            <div class="form-field full-width">
                <label class="form-label">Mã ưu đãi <span class="required">*</span></label>
                <input id="MaUD" class="form-input" placeholder="Nhập mã ưu đãi">
            </div>

            <div class="form-field">
                <label class="form-label">Tên ưu đãi <span class="required">*</span></label>
                <input id="TenUD" class="form-input" placeholder="Nhập tên ưu đãi">
            </div>

            <div class="form-field full-width">
                <label class="form-label">Mô tả <span class="required">*</span></label>
                <div class="rich-text-editor">
                    <div class="editor-toolbar">
                        <button type="button" class="toolbar-btn" data-command="bold" title="Bold (Ctrl+B)">
                            <i class="fas fa-bold"></i>
                        </button>
                        <button type="button" class="toolbar-btn" data-command="italic" title="Italic (Ctrl+I)">
                            <i class="fas fa-italic"></i>
                        </button>
                        <button type="button" class="toolbar-btn" data-command="underline" title="Underline (Ctrl+U)">
                            <i class="fas fa-underline"></i>
                        </button>
                        <div class="toolbar-separator"></div>
                        <button type="button" class="toolbar-btn" data-command="insertUnorderedList" title="Bullet List">
                            <i class="fas fa-list-ul"></i>
                        </button>
                        <button type="button" class="toolbar-btn" data-command="insertOrderedList" title="Numbered List">
                            <i class="fas fa-list-ol"></i>
                        </button>
                        <div class="toolbar-separator"></div>
                        <button type="button" class="toolbar-btn" data-command="justifyLeft" title="Align Left">
                            <i class="fas fa-align-left"></i>
                        </button>
                        <button type="button" class="toolbar-btn" data-command="justifyCenter" title="Align Center">
                            <i class="fas fa-align-center"></i>
                        </button>
                        <button type="button" class="toolbar-btn" data-command="justifyRight" title="Align Right">
                            <i class="fas fa-align-right"></i>
                        </button>
                        <button type="button" class="toolbar-btn" data-command="justifyFull" title="Justify (Căn đều)">
                            <i class="fas fa-align-justify"></i>
                        </button>
                    </div>
                    <div id="MoTa" class="editor-content" contenteditable="true" placeholder="Nhập mô tả..."></div>
                </div>
            </div>

            <div class="form-field">
                <label class="form-label">Ngày bắt đầu <span class="required">*</span></label>
                <input id="NgayBatDau" type="date" class="form-input">
            </div>

            <div class="form-field">
                <label class="form-label">Ngày kết thúc <span class="required">*</span></label>
                <input id="NgayKetThuc" type="date" class="form-input">
            </div>
            <div class="form-field">
                <label class="form-label">Ảnh <span class="required">*</span></label>
                <div class="file-input-container">
                    <input id="Anh" type="file" accept="image/*" class="form-input file-input" onchange="window.endowManagement.handleImageSelect(event)">
                    <div id="imagePreview" class="image-preview hidden">
                        <img id="previewImg" src="" alt="Preview" class="preview-image">
                        <button type="button" onclick="window.endowManagement.removeImage()" class="remove-image-btn">&times;</button>
                    </div>
                </div>
            </div>
            
        </div>

        <div class="modal-buttons">
            <button onclick="window.endowManagement.closeModal()" class="modal-button cancel">Hủy</button>
            <button onclick="window.endowManagement.saveEndow()" class="modal-button save">Lưu</button>
        </div>
    </div>
</div>
<!-- MODAL XEM CHI TIẾT ƯU ĐÃI -->
<div id="detailModal" class="endow-modal hidden">
    <div class="endow-modal-content max-w-xl"
         onclick="event.stopPropagation()">

        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-semibold">Chi tiết ưu đãi</h3>
            <button onclick="window.endowManagement.closeDetailModal()"
                    class="text-xl">&times;</button>
        </div>

        <div id="detailContent"></div>

        <div class="text-right mt-4">
            <button onclick="window.endowManagement.closeDetailModal()"
                    class="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400">
                Đóng
            </button>
        </div>
    </div>
</div>

</body>
</html>